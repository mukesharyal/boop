import{f as A,r as c,j as e,d as $,C as J,c as I,b as Z,g as y,h as ee,e as O,i as se}from"./index-CngHVNkC.js";const te="_chatContainer_189rb_1",ne="_chatBottom_189rb_18",V={chatContainer:te,chatBottom:ne},oe="_textMessage_51f5b_1",ie="_sentMessage_51f5b_32",ce="_receivedMessage_51f5b_37",ae="_sending_51f5b_42",re="_sent_51f5b_32",le="_deletedMessage_51f5b_50",de="_topMessage_51f5b_56",ue="_bottomMessage_51f5b_61",ge="_repliedMessage_51f5b_74",fe="_hasImage_51f5b_79",he="_hasReaction_51f5b_85",d={textMessage:oe,sentMessage:ie,receivedMessage:ce,sending:ae,sent:re,deletedMessage:le,topMessage:de,bottomMessage:ue,repliedMessage:ge,hasImage:fe,hasReaction:he},pe="_reaction_ovqd2_1",_e="_sentReaction_ovqd2_11",me="_receivedReaction_ovqd2_16",S={reaction:pe,sentReaction:_e,receivedReaction:me},xe=["👍","❤️","😆","😮","😢","😡"];function je({reaction:i,origin:s}){const[n,r]=A(()=>({scale:1}));return c.useEffect(()=>{r.start({from:{scale:0},to:{scale:1},config:{tension:300,friction:15}})},[i]),i!==-1?e.jsx($.span,{className:`${S.reaction} ${s==="sent"?S.sentReaction:S.receivedReaction}`,style:{...n},children:xe[i]}):e.jsx(e.Fragment,{})}const Me="_requestDiv_1le1e_2",ve="_decisionBox_1le1e_10",ye="_loading_1le1e_36",E={requestDiv:Me,decisionBox:ve,loading:ye};function Ie({index:i,sentId:s,receivedId:n}){const{dataChannel:r,peerName:h}=c.useContext(J),{setMessages:u,receivingImage:g}=c.useContext(I),{showNotification:o}=Z(),[t,a]=c.useState(!1),f=()=>{g.current===null?(r.current.send(JSON.stringify({type:"imageAccept",sentId:n,receivedId:s})),a(!0)):o("Please wait for a while!")},N=()=>{r.current.send(JSON.stringify({type:"imageReject",sentId:n,receivedId:s})),u(w=>{const j=[...w];return j.splice(i,1),j})};return t?e.jsxs("div",{className:E.loading,children:[e.jsx("span",{children:"L"}),e.jsx("span",{children:"o"}),e.jsx("span",{children:"a"}),e.jsx("span",{children:"d"}),e.jsx("span",{children:"i"}),e.jsx("span",{children:"n"}),e.jsx("span",{children:"g"}),e.jsx("span",{children:" "}),e.jsx("span",{children:"i"}),e.jsx("span",{children:"m"}),e.jsx("span",{children:"a"}),e.jsx("span",{children:"g"}),e.jsx("span",{children:"e"})]}):e.jsxs("div",{className:E.requestDiv,children:[e.jsxs("div",{children:[h.current," wants to send you an image"]}),e.jsxs("div",{className:E.decisionBox,children:[e.jsx("button",{onClick:f,children:"Accept"}),e.jsx("button",{onClick:N,children:"Reject"})]})]})}function H({index:i,prevMessage:s,nextMessage:n,message:r,replied:h}){const{dataChannel:u}=c.useContext(J),{chatBottom:g,pointerPosition:o,setActionsShown:t,setReactionsShown:a,setSelectedMessageId:f,setReplying:N,longPressed:w,atBottomRef:j,setImageDialog:U}=c.useContext(I),{sentId:p,receivedId:_,type:T,status:P,content:B,reaction:q,deleted:M,highlight:X}=r,G=()=>{window.history.pushState(null,"","/image"),U({src:B,sent:_===null})},Y={text:()=>e.jsxs("p",{children:[" ",B," "]}),image:()=>e.jsxs("p",{children:[" ",e.jsx("img",{src:B,onClick:G})," "]}),imageRequest:()=>e.jsx(Ie,{index:i,sentId:p,receivedId:_})};if(M===1)return e.jsx(e.Fragment,{});const[z,v]=A(()=>({scale:1,x:0})),x=c.useRef(null),R=c.useRef(!1),k=c.useRef(!0),D=c.useRef(0),L=c.useRef(null);c.useEffect(()=>{j.current&&(g.current.scrollIntoView({behavior:"smooth"}),j.current=!1),v.start({from:{scale:0,opacity:0},to:[{scale:1,opacity:1}],reset:!1,config:y.stiff})},[]),c.useEffect(()=>{if(k.current){k.current=!1;return}(async()=>(L.current.scrollIntoView({behavior:"instant"}),await new Promise(l=>setTimeout(l,100)),v.start({from:{scale:1},to:[{scale:1.2},{scale:1}],config:y.stiff})))()},[X]);const K=()=>{if(p===null&&q!==1){let l={type:"reaction",id:_,reaction:1};u.current.send(JSON.stringify(l))}},Q=ee({onPointerDown:({event:l})=>{R.current=!1,x.current=setTimeout(()=>{R.current||(o.current.x=l.clientX,o.current.y=l.clientY,w.current=!0,v.start({from:{scale:1},to:[{scale:1.1},{scale:1}],config:y.stiff}),t(!0),p===null&&a(!0),f(i))},500)},onPointerUp:()=>{setTimeout(()=>{w.current=!1},100),clearTimeout(x.current);const l=Date.now();l-D.current<500?(K(),D.current=0):D.current=l},onPointerLeave:()=>{clearTimeout(x.current)},onDrag:({last:l,movement:[m]})=>{if(p===null){if(m<0)return}else if(m>0)return;if(Math.abs(m)<5)return;R.current=Math.abs(m)>5,Math.abs(m)>60&&(f(i),N(!0));let W=_===null?Math.min(0,m):Math.max(0,m);v.start({x:W}),R.current&&x.current&&(clearTimeout(x.current),x.current=null),l&&v.start({x:0,config:{tension:500,friction:20}})}},{eventOptions:{passive:!1}});return e.jsxs($.div,{ref:L,...M!==0||T==="imageRequest"||P==="sending"?{}:Q(),style:{...z},className:`
        ${d.textMessage}
        ${P==="sending"?d.sending:d.sent}
        ${_===null?d.sentMessage:d.receivedMessage}
        ${(n==null?void 0:n.sentId)===p||(n==null?void 0:n.receivedId)===_?d.topMessage:""}
        ${(s==null?void 0:s.sentId)===p||(s==null?void 0:s.receivedId)===_?d.bottomMessage:""}
        ${h?d.repliedMessage:""}
        ${M===2?d.deletedMessage:""}
        ${q!==-1&&M!==2?d.hasReaction:""}
        ${T==="image"?d.hasImage:""}
      `,children:[(Y[T]||(()=>e.jsx("p",{children:e.jsx("span",{children:"Unknown type"})})))(),M!==2&&e.jsx(je,{reaction:q,origin:p===null?"received":"sent"})]})}const we="_replyToMessage_1f615_1",Re="_sentMessage_1f615_20",be="_receivedMessage_1f615_25",b={replyToMessage:we,sentMessage:Re,receivedMessage:be};function Ce({index:i,nextMessage:s,message:n}){const{messages:r,setMessages:h}=c.useContext(I),u=r.findIndex(t=>t.receivedId===n.replyTo.receivedId&&t.sentId===n.replyTo.sentId),g=r[u],o=()=>{setTimeout(()=>{h(t=>t.map((a,f)=>f===u?{...a,highlight:!a.highlight}:a))},100)};return e.jsxs(e.Fragment,{children:[e.jsx("a",{onClick:o,className:`
          ${b.replyToMessage}
          ${n.receivedId===null?b.sentMessage:b.receivedMessage}
          ${n.reaction!==-1?b.hasReaction:""}
        `,children:e.jsx("p",{children:g.type==="image"?"Image":g.content})}),e.jsx(H,{index:i,prevMessage:null,nextMessage:s,message:n,replied:!0},i)]})}const $e="_typingIndicator_1onvb_1",Ne="_dot_1onvb_15",C={typingIndicator:$e,dot:Ne};function Te({style:i}){return e.jsxs($.div,{className:C.typingIndicator,style:{...i,width:i.width.to(s=>`${s}rem`),height:i.height.to(s=>`${s}rem`)},children:[e.jsx("span",{className:C.dot}),e.jsx("span",{className:C.dot}),e.jsx("span",{className:C.dot})]})}const Be="_newMessageContainer_19wj1_1",qe="_newMessage_19wj1_1",F={newMessageContainer:Be,newMessage:qe};function De({style:i}){const s=()=>{n.current.scrollIntoView({behavior:"smooth"})},{chatBottom:n}=c.useContext(I);return e.jsx("div",{className:F.newMessageContainer,children:e.jsx($.div,{className:F.newMessage,onClick:s,style:i,children:"New Message"})})}function Ee(){const{messages:i,chatBottom:s,typing:n,newMessage:r,setNewMessage:h}=c.useContext(I);c.useLayoutEffect(()=>{const o=new IntersectionObserver(a=>{a.forEach(f=>{f.isIntersecting&&h(!1)})},{threshold:.1}),t=s.current;return t&&o.observe(t),()=>{t&&o.unobserve(t)}},[]);const u=O(n,{from:{width:0,height:0,opacity:0},enter:{width:4,height:2.1,opacity:1,config:y.stiff},leave:{width:0,height:0,opacity:0,config:y.stiff},onRest:()=>{se(s)&&s.current.scrollIntoView({behavior:"smooth"})}}),g=O(r,{from:{scale:0,opacity:0},enter:{scale:1,opacity:1,config:{tension:500,friction:15}},leave:{scale:0,opacity:0,config:{tension:500,friction:20}}});return e.jsxs("div",{className:V.chatContainer,children:[i.map((o,t,a)=>o.replyTo?e.jsx(Ce,{index:t,nextMessage:a[t+1],message:o},`${o.sentId}m${o.receivedId}`):e.jsx(H,{index:t,prevMessage:a[t-1],nextMessage:a[t+1],message:o,replied:!1},`${o.sentId}m${o.receivedId}`)),u((o,t)=>t?e.jsx(Te,{style:o}):null),g((o,t)=>t?e.jsx(De,{style:o}):null),e.jsx("div",{ref:s,className:V.chatBottom,children:"Hehe"},"chatBottom")]})}export{Ee as default};
