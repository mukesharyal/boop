import{f as A,r as c,j as e,d as N,C as J,c as j,b as Z,g as y,h as ee,e as O,i as se}from"./index-DT8xq9-a.js";const te="_chatContainer_4p2h9_1",ne="_chatBottom_4p2h9_16",V={chatContainer:te,chatBottom:ne},oe="_textMessage_9pwv2_1",ie="_sentMessage_9pwv2_30",ce="_receivedMessage_9pwv2_34",ae="_sending_9pwv2_48",re="_sent_9pwv2_30",le="_deletedMessage_9pwv2_56",de="_topMessage_9pwv2_62",ue="_bottomMessage_9pwv2_67",ge="_repliedMessage_9pwv2_82",he="_hasImage_9pwv2_87",fe="_hasReaction_9pwv2_93",d={textMessage:oe,sentMessage:ie,receivedMessage:ce,sending:ae,sent:re,deletedMessage:le,topMessage:de,bottomMessage:ue,repliedMessage:ge,hasImage:he,hasReaction:fe},pe="_reaction_8ykr8_1",_e="_sentReaction_8ykr8_11",me="_receivedReaction_8ykr8_16",S={reaction:pe,sentReaction:_e,receivedReaction:me},xe=["👍","❤️","😆","😮","😢","😡"];function ve({reaction:i,origin:s}){const[n,r]=A(()=>({scale:1}));return c.useEffect(()=>{r.start({from:{scale:0},to:{scale:1},config:{tension:300,friction:15}})},[i]),i!==-1?e.jsx(N.span,{className:`${S.reaction} ${s==="sent"?S.sentReaction:S.receivedReaction}`,style:{...n},children:xe[i]}):e.jsx(e.Fragment,{})}const we="_requestDiv_1le1e_2",Me="_decisionBox_1le1e_10",ye="_loading_1le1e_36",q={requestDiv:we,decisionBox:Me,loading:ye};function je({index:i,sentId:s,receivedId:n}){const{dataChannel:r,peerName:f}=c.useContext(J),{setMessages:u,receivingImage:g}=c.useContext(j),{showNotification:o}=Z(),[t,a]=c.useState(!1),h=()=>{g.current===null?(r.current.send(JSON.stringify({type:"imageAccept",sentId:n,receivedId:s})),a(!0)):o("Please wait for a while!")},T=()=>{r.current.send(JSON.stringify({type:"imageReject",sentId:n,receivedId:s})),u(I=>{const v=[...I];return v.splice(i,1),v})};return t?e.jsxs("div",{className:q.loading,children:[e.jsx("span",{children:"L"}),e.jsx("span",{children:"o"}),e.jsx("span",{children:"a"}),e.jsx("span",{children:"d"}),e.jsx("span",{children:"i"}),e.jsx("span",{children:"n"}),e.jsx("span",{children:"g"}),e.jsx("span",{children:" "}),e.jsx("span",{children:"i"}),e.jsx("span",{children:"m"}),e.jsx("span",{children:"a"}),e.jsx("span",{children:"g"}),e.jsx("span",{children:"e"})]}):e.jsxs("div",{className:q.requestDiv,children:[e.jsxs("div",{children:[f.current," wants to send you an image"]}),e.jsxs("div",{className:q.decisionBox,children:[e.jsx("button",{onClick:h,children:"Accept"}),e.jsx("button",{onClick:T,children:"Reject"})]})]})}function H({index:i,prevMessage:s,nextMessage:n,message:r,replied:f}){const{dataChannel:u}=c.useContext(J),{chatBottom:g,pointerPosition:o,setActionsShown:t,setReactionsShown:a,setSelectedMessageId:h,setReplying:T,longPressed:I,atBottomRef:v,setImageDialog:U}=c.useContext(j),{sentId:p,receivedId:_,type:b,status:E,content:B,reaction:k,deleted:w,highlight:X}=r,G=()=>{window.history.pushState(null,"","/image"),U({src:B,sent:_===null})},Y={text:()=>e.jsxs("p",{children:[" ",B," "]}),image:()=>e.jsxs("p",{children:[" ",e.jsx("img",{src:B,onClick:G})," "]}),imageRequest:()=>e.jsx(je,{index:i,sentId:p,receivedId:_})};if(w===1)return e.jsx(e.Fragment,{});const[z,M]=A(()=>({scale:1,x:0})),x=c.useRef(null),R=c.useRef(!1),P=c.useRef(!0),D=c.useRef(0),L=c.useRef(null);c.useEffect(()=>{v.current&&(g.current.scrollIntoView({behavior:"smooth"}),v.current=!1),M.start({from:{scale:0,opacity:0},to:[{scale:1,opacity:1}],reset:!1,config:y.stiff})},[]),c.useEffect(()=>{if(P.current){P.current=!1;return}(async()=>(L.current.scrollIntoView({behavior:"instant"}),await new Promise(l=>setTimeout(l,100)),M.start({from:{scale:1},to:[{scale:1.2},{scale:1}],config:y.stiff})))()},[X]);const K=()=>{if(p===null&&k!==1){let l={type:"reaction",id:_,reaction:1};u.current.send(JSON.stringify(l))}},Q=ee({onPointerDown:({event:l})=>{R.current=!1,x.current=setTimeout(()=>{R.current||(o.current.x=l.clientX,o.current.y=l.clientY,I.current=!0,M.start({from:{scale:1},to:[{scale:1.1},{scale:1}],config:y.stiff}),t(!0),p===null&&a(!0),h(i))},500)},onPointerUp:()=>{setTimeout(()=>{I.current=!1},100),clearTimeout(x.current);const l=Date.now();l-D.current<500?(K(),D.current=0):D.current=l},onPointerLeave:()=>{clearTimeout(x.current)},onDrag:({last:l,movement:[m]})=>{if(p===null){if(m<0)return}else if(m>0)return;if(Math.abs(m)<5)return;R.current=Math.abs(m)>5,Math.abs(m)>60&&(h(i),T(!0));let W=_===null?Math.min(0,m):Math.max(0,m);M.start({x:W}),R.current&&x.current&&(clearTimeout(x.current),x.current=null),l&&M.start({x:0,config:{tension:500,friction:20}})}},{eventOptions:{passive:!1}});return e.jsxs(N.div,{ref:L,...w!==0||b==="imageRequest"||E==="sending"?{}:Q(),style:{...z},className:`
        ${d.textMessage}
        ${E==="sending"?d.sending:d.sent}
        ${_===null?d.sentMessage:d.receivedMessage}
        ${(n==null?void 0:n.sentId)===p||(n==null?void 0:n.receivedId)===_?d.topMessage:""}
        ${(s==null?void 0:s.sentId)===p||(s==null?void 0:s.receivedId)===_?d.bottomMessage:""}
        ${f?d.repliedMessage:""}
        ${w===2?d.deletedMessage:""}
        ${k!==-1&&w!==2?d.hasReaction:""}
        ${b==="image"?d.hasImage:""}
      `,children:[(Y[b]||(()=>e.jsx("p",{children:e.jsx("span",{children:"Unknown type"})})))(),w!==2&&e.jsx(ve,{reaction:k,origin:p===null?"received":"sent"})]})}const Ie="_replyToMessage_1f615_1",Re="_sentMessage_1f615_20",Ce="_receivedMessage_1f615_25",C={replyToMessage:Ie,sentMessage:Re,receivedMessage:Ce};function $e({index:i,nextMessage:s,message:n}){const{messages:r,setMessages:f}=c.useContext(j),u=r.findIndex(t=>t.receivedId===n.replyTo.receivedId&&t.sentId===n.replyTo.sentId),g=r[u],o=()=>{setTimeout(()=>{f(t=>t.map((a,h)=>h===u?{...a,highlight:!a.highlight}:a))},100)};return e.jsxs(e.Fragment,{children:[e.jsx("a",{onClick:o,className:`
          ${C.replyToMessage}
          ${n.receivedId===null?C.sentMessage:C.receivedMessage}
          ${n.reaction!==-1?C.hasReaction:""}
        `,children:e.jsx("p",{children:g.type==="image"?"Image":g.content})}),e.jsx(H,{index:i,prevMessage:null,nextMessage:s,message:n,replied:!0},i)]})}const Ne="_typingIndicator_1aw03_1",Te="_dot_1aw03_13",$={typingIndicator:Ne,dot:Te};function be({style:i}){return e.jsxs(N.div,{className:$.typingIndicator,style:{...i,width:i.width.to(s=>`${s}rem`),height:i.height.to(s=>`${s}rem`)},children:[e.jsx("span",{className:$.dot}),e.jsx("span",{className:$.dot}),e.jsx("span",{className:$.dot})]})}const Be="_newMessageContainer_tkeh9_1",ke="_newMessage_tkeh9_1",F={newMessageContainer:Be,newMessage:ke};function De({style:i}){const s=()=>{n.current.scrollIntoView({behavior:"smooth"})},{chatBottom:n}=c.useContext(j);return e.jsx("div",{className:F.newMessageContainer,children:e.jsx(N.div,{className:F.newMessage,onClick:s,style:i,children:"New Message"})})}function qe(){const{messages:i,chatBottom:s,typing:n,newMessage:r,setNewMessage:f}=c.useContext(j);c.useLayoutEffect(()=>{const o=new IntersectionObserver(a=>{a.forEach(h=>{h.isIntersecting&&f(!1)})},{threshold:.1}),t=s.current;return t&&o.observe(t),()=>{t&&o.unobserve(t)}},[]);const u=O(n,{from:{width:0,height:0,opacity:0},enter:{width:4,height:2.1,opacity:1,config:y.stiff},leave:{width:0,height:0,opacity:0,config:y.stiff},onRest:()=>{se(s)&&s.current.scrollIntoView({behavior:"smooth"})}}),g=O(r,{from:{scale:0,opacity:0},enter:{scale:1,opacity:1,config:{tension:500,friction:15}},leave:{scale:0,opacity:0,config:{tension:500,friction:20}}});return e.jsxs("div",{className:V.chatContainer,children:[i.map((o,t,a)=>o.replyTo?e.jsx($e,{index:t,nextMessage:a[t+1],message:o},`${o.sentId}m${o.receivedId}`):e.jsx(H,{index:t,prevMessage:a[t-1],nextMessage:a[t+1],message:o,replied:!1},`${o.sentId}m${o.receivedId}`)),u((o,t)=>t?e.jsx(be,{style:o}):null),g((o,t)=>t?e.jsx(De,{style:o}):null),e.jsx("div",{ref:s,className:V.chatBottom,children:"Hehe"},"chatBottom")]})}export{qe as default};
